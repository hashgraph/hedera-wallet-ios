# .circleci/config.yml
version: 2
jobs:
  build-and-unit-test:
    macos:
      xcode: "11.0.0"
    environment:
      FL_OUTPUT_DIR: output
    steps:
      # A: Code checkout
      - checkout
      # B: Homebrew
      - run:
          name: Record Homebrew Version
          command: brew --version
      - run:
          name: Record Homebrew Formulae
          command: brew list
          # Available by 2.1.15
          # command: brew list --verbose
      - run:
          name: Record Homebrew Leaves
          command: brew leaves
      - run:
          name: Install ProtoBuf
          command: brew install protobuf
      - run:
          name: Install Swift-protobuf
          command: brew install swift-protobuf
      - run:
          name: Install gRPC-Swift
          command: brew install grpc-swift
      # C: Cocoapods
      - run:
          name: Record Gem Version
          command: gem --version
      - run:
          name: Install Cocoapods Gem
          command: gem install cocoapods
      - run:
          name: Record Cocoapods Version
          command: pod --version
      - run:
          name: Fetch CocoaPods Specs
          command: |
            curl https://cocoapods-specs.circleci.com/fetch-cocoapods-repo-from-s3.sh | bash -s cf
      - run:
          name: Install Dependencies in CocoaPods
          command: pod install --verbose
      # D: Generate Swift ProtoBuf Integration Files
      - run:
          name: Generate ProtoBuf Files
          command: ./gen-swift
      # E: iOS Code Signing Prep
      - run:
          name: Generate Certificate(s)
          # CIDEV_CERT=<secret>
          command: test "$CIDEV_CERT" && base64 --decode >'cidev.p12' <<< $CIDEV_CERT
      - run:
          name: Install Certificate(s)
          # CIDEV_PASSWD=<secret>
          command: fastlane gen_ci_cert
      - run:
          name: Generate Provisioning
          # CIDEV_PROV=<secret>
          command: test "$CIDEV_PROV" && base64 --decode >'cidev_prov.mobileprovision' <<< $CIDEV_PROV
      - run:
          name: Ensure Provisioning Directory
          command: mkdir -pv "$HOME/Library/MobileDevice/Provisioning Profiles/"
      - run:
          name: Install Provisioning
          # CIDEV_PROV_UUID
          command: test "$CIDEV_PROV_UUID" && cp 'cidev_prov.mobileprovision' "$HOME/Library/MobileDevice/Provisioning Profiles/$CIDEV_PROV_UUID.mobileprovision"
      # F: Build
      - run:
          name: Build
          command: xcodebuild -workspace HGCApp.xcworkspace -scheme HGCApp_Debug

workflows:
  version: 2
  build:
    jobs:
      - build-and-unit-test
